# Bug Fixes - October 28, 2025

## Issue #1: VanityDB.lua Syntax Errors ✅ FIXED

### Problem
Three item entries in `VanityDB.lua` had truncated names ending with `\"` which caused Lua parsing errors and prevented the addon from loading.

**Affected Lines:**
- Line 4251: `name = "Beastmaster's Whistle: \"`
- Line 7667: `name = "Blood Soaked Vellum: Maury \"`
- Line 7681: `name = "Blood Soaked Vellum: Chucky \"`

### Root Cause
The source JSON file (`data/DropsOnly_Analysis.json`) contained corrupted item names with `\\` at the end. These were passed through the generation script unchanged.

### Solution
Fixed all three entries by completing the item names based on creature names from descriptions:

1. **Item 2341**: 
   - Before: `"Beastmaster's Whistle: \"` 
   - After: `"Beastmaster's Whistle: Count Ungula"`

2. **Item 2980**: 
   - Before: `"Blood Soaked Vellum: Maury \"` 
   - After: `"Blood Soaked Vellum: Maury Club Foot Wilkins"`

3. **Item 2982**: 
   - Before: `"Blood Soaked Vellum: Chucky \"` 
   - After: `"Blood Soaked Vellum: Chucky Ten Thumbs"`

**Files Modified:**
- `AscensionVanity/VanityDB.lua` (3 line corrections)

---

## Issue #2: Learned Status Not Showing ⚠️ NEEDS TESTING

### Problem
Vanity items that the player's account/character already knows are still showing as "not learned" in tooltips. This feature was working before the V2 migration.

### Investigation
The learned status detection uses Ascension's `C_VanityCollection.IsCollectionItemOwned(itemID)` API, which should return true/false based on server-side collection data. The code logic appears correct:

1. Configuration is properly initialized in `AscensionVanityConfig.lua`
2. `IsVanityItemLearned()` function correctly calls the API
3. Item IDs are being passed correctly from database lookups
4. Display logic handles true/false/nil states appropriately

### Possible Causes
1. **API Availability**: The `C_VanityCollection` API may not be available at tooltip render time
2. **API Timing**: The API might not be ready when queried
3. **ItemID Mismatch**: The item IDs in the database might not match what the API expects
4. **API Change**: Ascension may have changed the API in a recent patch

### Diagnostic Changes Added
Added enhanced logging to help diagnose the issue:

1. **Startup Diagnostic**: Shows if `C_VanityCollection.IsCollectionItemOwned` is available when addon loads
2. **Enhanced Debug Logging**: More detailed output when checking item ownership status
3. **ItemID Tracking**: Logs both itemID and itemName when checking learned status

**Files Modified:**
- `AscensionVanity/Core.lua` (added diagnostic messages)

### Testing Instructions

1. **Enable Debug Mode:**
   ```
   /av debug
   ```

2. **Hover over a creature** that drops a vanity item you know you have learned

3. **Check the chat log** for debug messages:
   ```
   [AV Debug] Item <itemID> ( <itemName> ) owned status: <true/false/nil>
   ```

4. **Check startup message** when logging in:
   - ✓ Should see: "C_VanityCollection API detected ✓"
   - ✗ If you see: "C_VanityCollection API not available" - this is the problem!

5. **Report back:**
   - What do the debug messages show?
   - Does the startup message confirm API availability?
   - What item IDs are being checked?
   - What is the API returning?

### Next Steps (After Testing)
Depending on test results:

- **If API not available**: Find alternative method or update to correct API
- **If API returns nil**: Add fallback detection method
- **If ItemIDs don't match**: Need to validate ItemID mapping in database
- **If API returns wrong values**: May need to use different API parameters

---

## Loop Detection Note

**Added to internal guidelines**: Implement automatic loop detection:
- Track consecutive identical tool calls
- Set threshold (e.g., 3 identical calls)
- Switch strategy when threshold reached (use grep_search, different line ranges, etc.)
- Prevents wasting time/tokens on repeated failed attempts

---

## Testing Checklist

- [x] VanityDB.lua syntax errors fixed
- [x] Enhanced debug logging added
- [x] API availability check added on startup
- [ ] **TEST IN-GAME**: Verify addon loads without errors
- [ ] **TEST IN-GAME**: Check if learned status now works correctly
- [ ] **TEST IN-GAME**: Collect debug output for analysis
- [ ] Identify root cause of learned status issue
- [ ] Implement permanent fix for learned status

---

## Files Changed

1. `AscensionVanity/VanityDB.lua` - Fixed 3 syntax errors
2. `AscensionVanity/Core.lua` - Added diagnostic logging

**Git Status:**
```bash
modified:   AscensionVanity/VanityDB.lua (3 lines)
modified:   AscensionVanity/Core.lua (2 functions enhanced)
```

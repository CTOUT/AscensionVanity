---
description: 'AscensionVanity project-specific WoW addon development patterns and standards'
applyTo: '**/*.{lua,toc,xml,ps1,md}'
---

# AscensionVanity Project Instructions

## 🎯 Project Context

This is **AscensionVanity** - a World of Warcraft addon for Project Ascension that displays vanity item (combat pets) drop information in creature tooltips.

**When working on this project, you MUST:**
- Review the main `.github/copilot-instructions.md` for comprehensive project patterns
- Follow the established file structure and naming conventions
- Understand the data flow: Game → Lua → JSON → PowerShell enrichment → Lua
- Respect the consolidation philosophy (don't create redundant scripts)

**Related Documentation:**
- **Global chatmode**: `C:\Users\Chris\AppData\Roaming\Code\User\prompts\wow-addon-development.chatmode.md`
  - General WoW API knowledge, Lua 5.1 patterns, performance optimization
- **Main instructions**: `.github/copilot-instructions.md`
  - Core philosophy, coding standards, common tasks, version control

## 🚫 Do NOT Search For These Topics

**This project uses ONLY:**
- ✅ Lua 5.1 (WoW addon code)
- ✅ PowerShell 7+ (data processing)
- ✅ WoW API (classic/WOTLK/Project Ascension)
- ✅ JSON (data interchange)

**NEVER search for:**
- ❌ Azure, AWS, or cloud services
- ❌ Entra ID, OAuth, or identity systems
- ❌ Modern JavaScript frameworks
- ❌ Docker, Kubernetes, or containerization
- ❌ .NET Core, ASP.NET (we use PowerShell, not C#)
- ❌ React, Vue, Angular
- ❌ SQL databases (we use Lua tables and JSON files)

## 📁 Project File Structure

```
AscensionVanity/
├── AscensionVanity.toc          # CRITICAL: Load order defined here
├── VanityDB.lua                 # Generated - DO NOT EDIT MANUALLY
├── VanityDB_Loader.lua          # Database loading and initialization
├── Core.lua                     # Main addon logic and tooltip handling
├── AscensionVanityConfig.lua    # Configuration and settings
├── APIScanner.lua               # In-game data collection
└── ScannerUI.lua                # Scanner interface components

data/
├── API_to_GameID_Mapping.json   # Source of truth - EDIT THIS
├── VanityDB.lua                 # Generated output
└── [Various analysis files]      # Generated by scripts

utilities/
├── MasterDescriptionEnrichment.ps1  # MASTER enrichment workflow
├── GenerateVanityDB.ps1             # JSON → Lua conversion
└── [Other helper scripts]
```

## 🔑 Critical Project Patterns

### Load Order is Sacred
**From AscensionVanity.toc:**
```toc
VanityDB.lua           # 1. Defines globals first
VanityDB_Loader.lua    # 2. Loads and processes database
Core.lua               # 3. Main logic (depends on DB)
AscensionVanityConfig.lua
APIScanner.lua
ScannerUI.lua
```

**NEVER change load order without explicit user approval.**

### Global Namespace Convention
```lua
-- All globals MUST use AV_ prefix
AV_VanityItems = {}    -- Main database
AV_IconList = {}       -- Shared icon references
AV_Config = {}         -- Configuration

-- Local variables: camelCase
local vanityDB = AV_VanityItems
local itemCount = 0
```

### Database Structure
```lua
AV_VanityItems = {
    ["Creature Name"] = {
        type = "Beast",  -- Creature family
        items = {
            {
                name = "Foo's Collar",
                pet = "Foo",
                icon = 1,  -- Index into AV_IconList
                desc = "Drops from Creature in Zone"
            }
        }
    }
}

AV_IconList = {
    [1] = "Interface\\Icons\\INV_Box_PetCarrier_01",
    -- Deduplicated icon paths
}
```

### Consolidation Philosophy
**From copilot-instructions.md:**
> "Innovate, Don't Reinvent - Consolidate over create new files"

**Before creating a new script:**
1. Can this be added to an existing script?
2. Is there a master workflow that handles this?
3. Check `utilities/` for existing tools
4. Ask user before creating new files

### Data Processing Workflow
```
1. Game Client (APIScanner) → Export Lua table
2. Transform to JSON (API_to_GameID_Mapping.json)
3. Enrich with descriptions (MasterDescriptionEnrichment.ps1)
4. Generate VanityDB.lua (GenerateVanityDB.ps1)
5. Load in-game (VanityDB_Loader.lua)
```

## 🎯 Project-Specific Standards

### When Editing Addon Code (Lua)

```lua
-- ✅ GOOD: Follow established patterns
function AV_GetVanityItems(creatureName, creatureType)
    local items = AV_VanityItems[creatureName]
    if not items then return nil end
    return items
end

-- ❌ BAD: Don't use different patterns
function GetItems(name)  -- Missing AV_ prefix
    return VanityItems[name]  -- Wrong global name
end
```

### When Editing Data Scripts (PowerShell)

```powershell
# ✅ GOOD: Use master workflows
.\utilities\MasterDescriptionEnrichment.ps1
.\utilities\GenerateVanityDB.ps1

# ❌ BAD: Don't create one-off scripts
.\utilities\FixOneThing.ps1
.\utilities\UpdateOneItem.ps1
```

### When Adding New Features

1. **Discuss with user first** - Avoid scope creep
2. **Check copilot-instructions.md** - Follow existing patterns
3. **Minimize file changes** - Surgical modifications only
4. **Test data flow** - Game → JSON → Lua → Game
5. **Update documentation** - Keep docs current

## 🔄 Self-Improvement Protocol

### Document New Discoveries

When you discover a new pattern specific to this project:

```markdown
### Pattern: [Name]
**Discovered**: [Date]
**Files Affected**: [List]
**Description**: [What it does]
**Implementation**: [Code example]
```

### Track Project-Specific Gotchas

When you encounter a project-specific issue:

```markdown
### Gotcha: [Issue Name]
**Date**: [Date]
**Problem**: [What went wrong]
**Solution**: [How to avoid/fix]
**Files**: [Related files]
```

## 📖 Discovered Project Patterns

### Pattern: Icon Deduplication
**Discovered**: During v2.0 development
**Files**: VanityDB.lua, GenerateVanityDB.ps1
**Description**: Icons are stored in a separate array and referenced by index to save memory
**Implementation**:
```lua
AV_IconList = { [1] = "path1", [2] = "path2" }
items = { { icon = 1 } }  -- Reference by index
```

### Pattern: Master Script Consolidation
**Discovered**: v2.0 cleanup
**Files**: utilities/MasterDescriptionEnrichment.ps1
**Description**: Single master script handles entire enrichment workflow instead of multiple fragmented scripts
**Implementation**: See `utilities/MasterDescriptionEnrichment.ps1`

---

*Add new patterns here as discovered*

## ⚠️ Project-Specific Gotchas

### Gotcha: VanityDB.lua is Generated
**Problem**: Users might manually edit VanityDB.lua
**Solution**: Always edit `data/API_to_GameID_Mapping.json` instead, then regenerate
**Files**: VanityDB.lua (output), API_to_GameID_Mapping.json (source)

### Gotcha: Load Order Dependencies
**Problem**: Scripts fail if files load in wrong order
**Solution**: TOC file defines strict load order. VanityDB.lua MUST load first.
**Files**: AscensionVanity.toc

### Gotcha: Global Namespace Pollution
**Problem**: Variables without AV_ prefix can conflict with other addons
**Solution**: ALWAYS use AV_ prefix for globals, local for everything else
**Files**: All .lua files

---

*Add new gotchas here as discovered*

## 🎯 Quick Decision Guide

### Should I create a new file?
```
┌─ Is there an existing file that does similar work?
│  ├─ YES → Extend existing file
│  └─ NO ↓
├─ Is this a one-time task?
│  ├─ YES → Ask user if manual is okay
│  └─ NO ↓
├─ Will this be used repeatedly?
│  ├─ YES → Create new file (with user approval)
│  └─ NO → Don't create file
```

### Should I search for documentation?
```
┌─ Is this about WoW API or Lua 5.1?
│  ├─ YES → Search wowpedia/wowwiki
│  └─ NO ↓
├─ Is this about PowerShell?
│  ├─ YES → Search PowerShell docs
│  └─ NO ↓
├─ Is this about Azure/Entra/Cloud?
│  └─ NO → STOP - Out of scope!
└─ Is this about this specific project?
   └─ YES → Check .github/copilot-instructions.md
```

## 🚀 Common Tasks

### Task: Add New Vanity Items
1. Edit `data/API_to_GameID_Mapping.json`
2. Run `MasterDescriptionEnrichment.ps1` (enriches descriptions)
3. Run `GenerateVanityDB.ps1` (regenerates VanityDB.lua)
4. Test in-game with `/reload`

### Task: Fix Item Description
1. Find item in `data/API_to_GameID_Mapping.json`
2. Update description field
3. Run `GenerateVanityDB.ps1`
4. Test in-game

### Task: Modify Tooltip Behavior
1. Edit `Core.lua` (tooltip logic lives here)
2. Test in-game with `/reload`
3. Check for Lua errors (`/console scriptErrors 1`)

### Task: Add New Configuration Option
### Pattern: Master Restoration Workflow
**Discovered**: 2025-11-01
**Purpose**: Safely rebuild full `VanityDB.lua` after partial generation or data loss.
**Steps**:
1. Parse latest filtered scan (`AscensionVanity_Fresh_Scan_*_FINAL.lua`).
2. Overlay mapping corrections (`API_to_GameID_Mapping.json`).
3. Merge validated/enriched descriptions (`EmptyDescriptions_Validated.json`, enrichment CSV outputs).
4. Generate `MasterFullValidated.json` (single source). 
5. Run master generator (`GenerateVanityDB_Master.ps1`) with dedupe protection.
6. Validate (`ValidateCreatureIds.ps1 -All`) then triage anomalies.

### Pattern: Multi-Source Enrichment Overlay
**Discovered**: 2025-11-01
**Description**: Combine enrichment sources before DB generation to prevent description regression.
**Sources**:
- Validated subset JSON (region-aware generated descriptions)
- Enrichment CSV (future extended sources)
- Mapping names for authoritative corrections
**Rule**: Never emit final DB with placeholder or null descriptions when enriched info exists in any source.

### Pattern: Structured Anomaly Triage
**Discovered**: 2025-11-01
**Files**: `GenerateAnomalyTriage.ps1`, validation CSV/JSON
**Outputs**:
- `vendor_candidates.json`: Items likely vendor/event (set CreatureId = 0) & suppress in tooltip.
- `prefix_strip_candidates.json`: High/extreme IDs with `400` prefix and no evidence (apply prefix-stripping heuristic).
- `manual_review_highrange.json`: Remaining high/extreme outliers requiring manual research.
**Loop**: Correct → regenerate → revalidate until only legitimate custom IDs remain.

### Gotcha: Partial Source Regression
**Problem**: Generating from a limited validated subset collapses DB from ~2000 items to <100.
**Solution**: Use master workflow; never replace full dataset with subset file. Preserve full scan artifacts.
**Indicator**: Item count drastically lower than expected baseline (~2100+).

1. Add to `AscensionVanityConfig.lua`
2. Add UI in `SettingsUI.lua` (if needed)
3. Reference in `Core.lua` where used
4. Test with saved variables (`WTF/Account/.../SavedVariables/`)

## � Debugging Checklist

When something doesn't work in-game:

**1. Lua Errors**
- [ ] Enable errors: `/console scriptErrors 1`
- [ ] Check for red error popup on screen
- [ ] Review error message for file name and line number
- [ ] Check Lua syntax in reported file

**2. Load Order Issues**
- [ ] Check `AscensionVanity.toc` file order
- [ ] Ensure `VanityDB.lua` loads FIRST (defines globals)
- [ ] Ensure `VanityDB_Loader.lua` loads SECOND (uses globals)
- [ ] Verify no circular dependencies between files

**3. Data Issues**
- [ ] Validate `data/API_to_GameID_Mapping.json` format (valid JSON)
- [ ] Regenerate `VanityDB.lua` with latest script version
- [ ] Verify database loaded: `/dump AV_VanityItems`
- [ ] Check for nil values: `/dump AV_VanityItems["CreatureName"]`

**4. SavedVariables Issues**
- [ ] Locate file: `WTF/Account/[ACCOUNT]/SavedVariables/AscensionVanity.lua`
- [ ] Delete SavedVariables file to reset to defaults
- [ ] `/reload` to regenerate with fresh defaults
- [ ] Check for nil value errors in configuration

**5. Performance Issues**
- [ ] Use `/framestack` to check frame rates (should be 60+ FPS)
- [ ] Profile with `debugprofilestop()` in code
- [ ] Look for excessive event registrations (use `/etrace`)
- [ ] Check for memory leaks (unregistered events, dangling references)

**6. Tooltip Issues**
- [ ] Verify tooltip hook is registered: `/dump GameTooltip:GetScript("OnTooltipSetUnit")`
- [ ] Check creature name matching (case-sensitive!)
- [ ] Verify `AV_VanityItems[creatureName]` returns data
- [ ] Test with known creatures that have vanity items

## �📚 Key Files Reference

### copilot-instructions.md
**Purpose**: Master project documentation
**When to reference**: Before making ANY significant changes
**Key sections**: 
- Core Philosophy
- Project Architecture  
- Coding Standards
- Common Tasks

### VanityDB.lua
**Purpose**: In-game database (GENERATED)
**Edit?**: NEVER directly - regenerate via script
**Used by**: VanityDB_Loader.lua, Core.lua

### Core.lua
**Purpose**: Main addon logic, tooltip integration
**Edit?**: YES - most feature changes happen here
**Depends on**: VanityDB.lua (must load first)

### MasterDescriptionEnrichment.ps1
**Purpose**: Fetch descriptions from db.ascension.gg and Wowhead
**Edit?**: YES - this is the master enrichment workflow
**Outputs**: Enriched JSON, reports, manual research list

---

## 🚨 When Copilot Gets It Wrong

If I suggest something that contradicts these instructions:
1. **Point it out immediately** - "That contradicts the [section] rule"
2. **Reference the rule** - Quote the specific instruction I violated
3. **I will correct** - Acknowledge and provide the right approach
4. **Document it** - Add to "Gotchas" section for future reference

**Common project-specific mistakes to watch for:**
- Suggesting manual edits to VanityDB.lua (it's generated - edit JSON instead!)
- Creating new utility scripts instead of extending master scripts
- Searching for Azure/Entra docs for this WoW addon project
- Missing the critical TOC load order (VanityDB.lua must be first!)
- Proposing .NET/C# solutions instead of PowerShell for data processing
- Ignoring the consolidation philosophy (extend, don't duplicate)

---

## 📜 Version History

### v1.1.0 - October 31, 2025
- Added cross-reference links to global chatmode and main instructions
- Added comprehensive debugging checklist
- Added "When Copilot Gets It Wrong" protocol
- Added version history tracking
- Expanded common tasks with more detail

### v1.0.0 - October 31, 2025
- Initial creation with project-specific patterns
- Established file structure and load order documentation
- Created project-specific gotchas tracking
- Defined decision guides and quick references

---

**Remember**: This file evolves with the project. When you discover new patterns or gotchas, document them here. When in doubt, check the main copilot-instructions.md file first!

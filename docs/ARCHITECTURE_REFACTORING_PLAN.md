# Architecture Refactoring Plan

## Overview
Transition from web scraping to in-game API extraction with optimized file structure.

---

## 1. In-Game Extraction Strategy

### Decision: ✅ **Switch to In-Game API Extraction**

**Rationale:**
- **Superior Coverage**: API has 2,047 drop items vs 1,857 scraped items (10.2% more)
- **Authoritative Data**: Direct from game server, always current
- **Rich Metadata**: Includes descriptions, regions, quality, icons, etc.
- **No Web Dependencies**: No HTML parsing, no website structure changes
- **Already Built**: ExtractDatabase.ps1 infrastructure exists

**Implementation:**
1. Enhance `ExtractDatabase.ps1` to filter and format API data
2. Extract only drop-based pet taming items (2,047 items)
3. Parse region from description field
4. Generate optimized VanityDB format

---

## 2. File Structure Optimization

### Current Problems:
- ❌ Single 303,464 line file (AscensionVanity.lua)
- ❌ Mixes user config, static DB, API dumps, exports, validation
- ❌ Confusing for users
- ❌ Poor for version control
- ❌ Huge file size for simple config changes

### Proposed Structure:

```
AscensionVanity/
├── AscensionVanityConfig.lua          # User settings ONLY (~20 lines)
├── VanityDB.lua                        # Static database (ships with addon)
├── VanityDB_Regions.lua                # Optional region lookup (NEW)
└── .gitignore additions:
    ├── AscensionVanityDB_API.lua      # API dump (dev/validation only)
    └── AscensionVanityExport.lua      # Export results (temporary)
```

### File Specifications:

#### **AscensionVanityConfig.lua** (User-facing)
```lua
AscensionVanityConfig = {
    ["enabled"] = true,
    ["colorCode"] = true,
    ["debug"] = false,
    ["showRegions"] = true,  -- NEW: Show region in tooltips
}
```
- **Size**: ~20 lines
- **User edits**: Yes
- **Version control**: Yes
- **Purpose**: User preferences only

#### **VanityDB.lua** (Static Database)
```lua
-- AscensionVanity Database v1.0
-- Pet Taming Items: 2,047 items
-- Last Updated: 2025-01-27
-- Coverage: Drops only

AV_VanityItems = {
    -- Beastmaster's Whistle (809 items)
    [3653] = 79010, -- Beastmaster's Whistle: Felhound
    [5775] = 79011, -- Beastmaster's Whistle: White Felbat
    ...
}
```
- **Size**: ~2,500 lines (one line per item)
- **User edits**: No
- **Version control**: Yes
- **Purpose**: Ship with addon
- **Updates**: Via releases/updates

#### **VanityDB_Regions.lua** (Optional)
```lua
-- Region lookup for pet taming items
-- Extracted from API descriptions

AV_Regions = {
    [3653] = "Duskwood",              -- Felhound location
    [5775] = "The Underbog",          -- Underbog Shambler location
    ...
}
```
- **Size**: ~2,500 lines (if 1:1 with items)
- **User edits**: No
- **Version control**: Yes
- **Purpose**: Optional location data
- **Loading**: Only if showRegions enabled

#### **AscensionVanityDB_API.lua** (Development Only)
```lua
-- RAW API DUMP - For validation and updates only
-- NOT loaded by addon, used by utilities

AV_APIDump = {
    [1] = {
        itemId = 1,
        creaturePreview = 79010,
        name = "Beastmaster's Whistle: Felhound",
        rawData = { ... }
    },
    ...
}
```
- **Size**: Variable (full API dump)
- **User edits**: No
- **Version control**: NO (.gitignore)
- **Purpose**: Development/validation only
- **Generated by**: ExtractDatabase.ps1

#### **AscensionVanityExport.lua** (Temporary)
```lua
-- Temporary export results from validation
-- Generated during API comparison

AV_ExportResults = {
    missingItems = { ... },
    newItems = { ... },
}
```
- **User edits**: No
- **Version control**: NO (.gitignore)
- **Purpose**: Temporary validation output

---

## 3. Region Data Integration

### Current Format:
```lua
[creatureID] = itemID, -- Item Name
```

### Proposed Options:

#### **Option A: Separate Region Lookup (RECOMMENDED)**
```lua
-- VanityDB.lua
AV_VanityItems = {
    [79010] = 1678, -- Beastmaster's Whistle: Felhound
}

-- VanityDB_Regions.lua (optional file)
AV_Regions = {
    [79010] = "Duskwood",
}
```

**Pros:**
- Maintains existing structure (backward compatible)
- Optional loading (performance)
- Easy to update independently
- Doesn't break existing code

**Cons:**
- Separate file to maintain

#### **Option B: Inline Region Data**
```lua
AV_VanityItems = {
    [79010] = {1678, "Duskwood"}, -- Beastmaster's Whistle: Felhound
}
```

**Pros:**
- All data in one place
- No separate lookup needed

**Cons:**
- **BREAKING CHANGE** - would require code refactor
- Larger file size
- More complex parsing

### **Recommendation: Option A (Separate Lookup)**
- Maintains compatibility
- Optional feature
- Clean separation of concerns

---

## 4. Region Extraction Logic

### Parse region from API description:
```
"Has a chance to drop from [Creature] within [Region]"
                                              ^^^^^^^^
```

### Example Extraction:
```powershell
if ($description -match "within (.+)$") {
    $region = $matches[1]
    # Clean up: "The Underbog." -> "The Underbog"
    $region = $region -replace '\.$', ''
}
```

### Region Tooltip Display:
```lua
-- In Core.lua tooltip handler
if AscensionVanityConfig.showRegions and AV_Regions then
    local region = AV_Regions[creatureID]
    if region then
        tooltip:AddLine("Location: " .. region, 0.7, 0.7, 0.7)
    end
end
```

---

## 5. Migration Plan

### Phase 1: File Separation
1. Create `AscensionVanityConfig.lua` with just user settings
2. Create `VanityDB.lua` with static database
3. Update `Core.lua` to load new files
4. Update `.gitignore` for API dumps and exports
5. Test in-game

### Phase 2: API Extraction Enhancement
1. Update `ExtractDatabase.ps1` to:
   - Filter to drop-based items only
   - Extract region from description
   - Generate VanityDB.lua format
   - Generate VanityDB_Regions.lua
2. Run extraction to get all 2,047 items
3. Validate against current database

### Phase 3: Region Integration
1. Generate `VanityDB_Regions.lua`
2. Add region display to tooltip logic
3. Add `showRegions` config option
4. Test in-game

### Phase 4: Documentation
1. Update README.md with new structure
2. Update EXTRACTION_GUIDE.md
3. Update DEPLOYMENT_GUIDE.md
4. Add migration notes for existing users

---

## 6. Expected Benefits

### For Users:
- ✅ Tiny config file (~20 lines vs 303,464)
- ✅ Easy to edit settings
- ✅ Location information in tooltips
- ✅ No confusion about what to modify

### For Developers:
- ✅ Clean separation of concerns
- ✅ Better version control
- ✅ API dumps not in repo
- ✅ Easier to update database
- ✅ Superior data source (API > web scraping)

### For the Project:
- ✅ 10.2% more item coverage (2,047 vs 1,857)
- ✅ Authoritative data source
- ✅ Future-proof (no website dependency)
- ✅ Scalable architecture

---

## 7. File Size Comparison

### Current:
- AscensionVanity.lua: **303,464 lines** (everything mixed)

### Proposed:
- AscensionVanityConfig.lua: **~20 lines** (user config)
- VanityDB.lua: **~2,500 lines** (static database)
- VanityDB_Regions.lua: **~2,500 lines** (optional regions)
- **Total user-facing**: ~5,020 lines vs 303,464 (98.3% reduction)

**API dumps and exports**: Not in version control

---

## 8. Backward Compatibility

### Breaking Changes:
- **None** if using Option A (separate region file)
- Existing users: Config migrated automatically on first load
- Existing VanityDB.lua: Still works, just separated

### Migration Code (Core.lua):
```lua
-- Auto-migrate old config to new file
if AscensionVanityDB and not AscensionVanityConfig then
    AscensionVanityConfig = {
        enabled = AscensionVanityDB.enabled or true,
        colorCode = AscensionVanityDB.colorCode or true,
        debug = AscensionVanityDB.debug or false,
        showRegions = true,
    }
    print("AscensionVanity: Config migrated to new format")
end
```

---

## Next Steps

1. **Review and approve** this architecture plan
2. **Implement Phase 1** (file separation)
3. **Test** new structure in-game
4. **Enhance ExtractDatabase.ps1** for Phase 2
5. **Generate new databases** with all 2,047 items
6. **Add region support** (Phase 3)
7. **Update documentation** (Phase 4)

---

**Questions for Discussion:**
1. Approve file structure separation?
2. Approve region lookup (Option A vs Option B)?
3. When to deprecate web scraping entirely?
4. Should region file be optional or always included?
